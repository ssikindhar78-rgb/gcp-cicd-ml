steps:
  # :one: Pull the Docker image from Docker Hub
  - name: gcr.io/cloud-builders/docker
    args:
      - pull
      - ${_DOCKER_IMAGE}

  # :two: Tag the image for Artifact Registry
  - name: gcr.io/cloud-builders/docker
    args:
      - tag
      - ${_DOCKER_IMAGE}
      - us-central1-docker.pkg.dev/$PROJECT_ID/placement-repo/${_SERVICE_NAME}:$COMMIT_SHA

  # :three: Push the image to Artifact Registry
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - us-central1-docker.pkg.dev/$PROJECT_ID/placement-repo/${_SERVICE_NAME}:$COMMIT_SHA

  # :four: Deploy the ML & AI 2026 model to Cloud Run
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      - run
      - deploy
      - ${_SERVICE_NAME}
      - --image
      - us-central1-docker.pkg.dev/$PROJECT_ID/placement-repo/${_SERVICE_NAME}:$COMMIT_SHA
      - --region
      - ${_REGION}
      - --platform
      - managed
      - --allow-unauthenticated
      - --port
      - ${_PORT}
      - --memory
      - ${_MEMORY}
      - --cpu
      - ${_CPU}

# Store built images (Artifact Registry)
images:
  - us-central1-docker.pkg.dev/$PROJECT_ID/placement-repo/${_SERVICE_NAME}:$COMMIT_SHA

# Timeout for the build
timeout: 1200s

# Logging configuration
options:
  logging: CLOUD_LOGGING_ONLY

# Substitutions for customizable values
substitutions:
  _DOCKER_IMAGE: 03sarath/ml-app:v2
  _SERVICE_NAME: placement-app
  _REGION: us-central1
  _PORT: "8080"
  _MEMORY: 512Mi
  _CPU: "1"